{{! 
    Feed template for the Mindscape feed plugin.
    This template renders the navigation sidebar, the form for creating new posts,
    the list of existing posts, their attachments and comments, and forms for
    adding comments.  Display elements are conditioned on the capabilities
    (canpost and cancomment) passed from the feed_page renderable.
}}

<!-- Feed page layout: a row with a sidebar for navigation and a central column for the feed -->
<div class="container-fluid my-4">
  <div class="row">
    <!-- Sidebar navigation -->
    <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar">
      <div class="p-3">
        <div class="d-flex align-items-center mb-3">
          {{{usernav.userpic}}}
          <span class="ms-2 fw-bold">{{usernav.fullname}}</span>
        </div>
        <ul class="nav flex-column">
          {{#usernav.links}}
            <li class="nav-item mb-2"><a class="nav-link" href="{{url}}">{{label}}</a></li>
          {{/usernav.links}}
        </ul>
      </div>
    </nav>
    <!-- Main feed column; center it and limit width -->
    <div class="col-md-9 col-lg-6 mx-auto">
      <section class="local-mindscape-feed">
        {{#canpost}}
        <form class="card shadow-sm p-3 mb-3 mindscape-post-form" method="post" action="{{{postformaction}}}" enctype="multipart/form-data" data-ajax="1">
          <div class="mb-2">
            <textarea name="content" class="form-control border rounded mb-2" rows="3" placeholder="{{#str}}writepost, local_mindscape_feed{{/str}}"></textarea>
          </div>
          <div class="mb-3 d-flex align-items-center">
            <input id="mindscape-attach-input" type="file" name="attachments[]" multiple class="d-none">
            <label for="mindscape-attach-input" class="btn btn-outline-secondary btn-sm me-2" title="{{#str}}attachfile, local_mindscape_feed{{/str}}">
              &#128206;
            </label>
            <!-- Attachment label shows the selected file names or number of files. -->
            <span id="mindscape-attach-label" class="text-muted small me-2"></span>
            <input type="hidden" name="sesskey" value="{{sesskey}}">
            <button type="submit" class="btn btn-primary btn-sm">{{#str}}publish, local_mindscape_feed{{/str}}</button>
          </div>
        </form>
        {{/canpost}}
        <!-- Link to debates page -->
        <div class="mb-3">
          <a class="btn btn-outline-primary btn-sm" href="{{debatesurl}}">{{#str}}viewdebates, local_mindscape_feed{{/str}}</a>
        </div>
        {{#posts}}
        <article class="card p-3 mb-3" id="p{{id}}">
          <header class="d-flex align-items-center gap-2 mb-2">
            {{{userpic}}}
            <strong>{{fullname}}</strong>
            <span class="text-muted ms-auto">{{time}}</span>
            <!-- Three-dot menu for owner or moderator actions (edit/delete).  Placed in header for compactness. -->
            <div class="dropdown ms-2">
              <button class="btn btn-sm btn-link text-muted p-0" type="button" id="post{{id}}dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                &#x22EE;
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="post{{id}}dropdown">
                <!-- Edit action shown for post owners and moderators. -->
                {{#isowner}}
                  <li><a class="dropdown-item" href="{{editurl}}">{{#str}}edit, local_mindscape_feed{{/str}}</a></li>
                {{/isowner}}
                {{^isowner}}{{#canmoderate}}
                  <li><a class="dropdown-item" href="{{editurl}}">{{#str}}edit, local_mindscape_feed{{/str}}</a></li>
                {{/canmoderate}}{{/isowner}}
                <!-- Delete action shown only to moderators.  Use a form to send POST request. -->
                {{#canmoderate}}
                  <li>
                    <form method="post" action="{{{deleteformaction}}}" onsubmit="return confirm('{{#str}}confirmdelete, local_mindscape_feed{{/str}}');">
                      <input type="hidden" name="postid" value="{{id}}">
                      <input type="hidden" name="sesskey" value="{{sesskey}}">
                      <button type="submit" class="dropdown-item text-danger">{{#str}}delete, local_mindscape_feed{{/str}}</button>
                    </form>
                  </li>
                {{/canmoderate}}
              </ul>
            </div>
          </header>
          <div class="feed-content mb-2">{{{content}}}</div>
          {{#attachments}}
            <div class="attachment mb-2">
              {{#isimage}}
                <img src="{{{url}}}" alt="{{filename}}" class="img-fluid rounded">
              {{/isimage}}
              {{^isimage}}
                <a href="{{{url}}}" target="_blank">{{filename}}</a>
              {{/isimage}}
            </div>
          {{/attachments}}
          <!-- Reaction buttons: like and dislike with counts.  Use Unicode icons for simplicity. -->
          <div class="d-flex align-items-center mb-2">
            <form class="d-inline me-1" method="post" action="{{likeformaction}}">
              <input type="hidden" name="postid" value="{{id}}">
              <input type="hidden" name="sesskey" value="{{sesskey}}">
              {{#likes.liked}}
                <button type="submit" name="action" value="unlike" class="btn btn-sm btn-link p-0 text-primary" title="{{#str}}unlike, local_mindscape_feed{{/str}}">üëç</button>
              {{/likes.liked}}
              {{^likes.liked}}
                <button type="submit" name="action" value="like" class="btn btn-sm btn-link p-0" title="{{#str}}like, local_mindscape_feed{{/str}}">üëç</button>
              {{/likes.liked}}
            </form>
            <span class="me-2 small">{{likes.count}}</span>
            <form class="d-inline me-1" method="post" action="{{dislikeformaction}}">
              <input type="hidden" name="postid" value="{{id}}">
              <input type="hidden" name="sesskey" value="{{sesskey}}">
              {{#dislikes.disliked}}
                <button type="submit" name="action" value="undislike" class="btn btn-sm btn-link p-0 text-danger" title="{{#str}}undislike, local_mindscape_feed{{/str}}">üëé</button>
              {{/dislikes.disliked}}
              {{^dislikes.disliked}}
                <button type="submit" name="action" value="dislike" class="btn btn-sm btn-link p-0" title="{{#str}}dislike, local_mindscape_feed{{/str}}">üëé</button>
              {{/dislikes.disliked}}
            </form>
            <span class="me-2 small">{{dislikes.count}}</span>
          </div>
          <section class="comments mt-3">
            {{#comments}}
            <div class="d-flex align-items-start gap-2 mb-2">
              {{{userpic}}}
              <div>
                <div><strong>{{fullname}}</strong></div>
                <div>{{{content}}}</div>
                <small class="text-muted">{{time}}</small>
                {{#iscommentowner}}
                  <a href="{{commentediturl}}" class="btn btn-sm btn-outline-secondary ms-2">{{#str}}edit, local_mindscape_feed{{/str}}</a>
                {{/iscommentowner}}
                {{^iscommentowner}}
                  {{#../canmoderate}}
                    <a href="{{commentediturl}}" class="btn btn-sm btn-outline-secondary ms-2">{{#str}}edit, local_mindscape_feed{{/str}}</a>
                  {{/../canmoderate}}
                {{/iscommentowner}}
              </div>
            </div>
            {{/comments}}
            {{^comments}}
              <div class="text-muted">{{#str}}nocomments, local_mindscape_feed{{/str}}</div>
            {{/comments}}
            {{#cancomment}}
            <form class="mt-2 mindscape-comment-form" method="post" action="{{{commentformaction}}}" data-postid="{{id}}" data-ajax="1">
              <div class="input-group">
                <textarea name="content" class="form-control" rows="2" placeholder="{{#str}}comment, local_mindscape_feed{{/str}}"></textarea>
                <input type="hidden" name="sesskey" value="{{sesskey}}">
                <button class="btn btn-outline-primary">{{#str}}comment, local_mindscape_feed{{/str}}</button>
              </div>
            </form>
            {{/cancomment}}
          </section>
        </article>
        {{/posts}}
        {{^posts}}
        <div class="alert alert-info">{{#str}}nopostsyet, local_mindscape_feed{{/str}}</div>
        {{/posts}}
      </section>
    </div>
  </div>
</div>

<!-- Inline script to update the attachment label when files are selected. -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  var input = document.getElementById('mindscape-attach-input');
  var label = document.getElementById('mindscape-attach-label');
  if (input && label) {
    input.addEventListener('change', function() {
      if (this.files && this.files.length > 0) {
        if (this.files.length === 1) {
          label.textContent = this.files[0].name;
        } else {
          label.textContent = this.files.length + ' arquivos anexados';
        }
      } else {
        label.textContent = '';
      }
    });
  }
});
</script>